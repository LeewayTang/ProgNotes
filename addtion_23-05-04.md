> Debug-23-05-04 的补充知识  
在 `Debug-23-05-04.md`中讨论了WebRTC接收视频包时预处理解包H264的过程，这里对H264的包结构进行补充。

在 WebRTC 中，处理 H.264 视频流时，通常会处理以下三种类型的 RTP 包：

1. **STAP-A（Single-Time Aggregation Packet Type A）**：将多个较小的 NALU 聚合到一个 RTP 包中进行传输。这种类型的 RTP 包用于将多个 NALU（例如 SPS、PPS等）一起发送。在接收端，需要将 STAP-A 包中的各个 NALU 分离出来并进行解码。
```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         RTP Header                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|STAP-A NAL HDR |         NALU 1 Size           | NALU 1 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         NALU 1 Data                           |
|                             ...                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         NALU 2 Size           | NALU 2 HDR    |               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
|                         NALU 2 Data                           |
|                             ...                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             ...                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         NALU N Size           | NALU N HDR    |               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
|                         NALU N Data                           |
|                             ...                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

```
各个字段的解释如下：

- **STAP-A NAL HDR**：STAP-A NAL 头部，包含负载类型、F 和 NRI 标志等信息。负载类型的 5 位表示 STAP-A（24）。
- **NALU 1 Size**：第一个 NALU 的大小（用 16 位无符号整数表示）。
- **NALU 1 HDR**：第一个 NALU 的头部，包含其类型、F 和 NRI 标志等信息。
- **NALU 1 Data**：第一个 NALU 的有效负载数据。

以此类推，直到 NALU N。STAP-A 包允许将多个 NALU 聚合到一个 RTP 包中，从而减少传输时的开销。



2. **FU-A（Fragmentation Unit A）**：当 H.264 帧较大时（大于 MTU 大小），需要将 NALU 分片。这种情况下，使用 FU-A 类型的 RTP 包将大型 NALU 分成多个小片并进行传输。在接收端，这些 FU-A 片需要重新组合成完整的 NALU。

H.264 的 FU-A（Fragmentation Unit A）视频包在 RTP 中的结构如下所示：

```

      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                            RTP Header                         |
      +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
      |   PayloadHdr (Type) |   NAL Unit Payload                      |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
      |                                                               |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

RTP Header：包含标准 RTP 头部信息，例如序列号、时间戳等。

PayloadHdr (Type)：包含 H.264 NALU 的类型信息和 FU-A 的相关标志。它由以下两个字节组成：

```
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |F|NRI|      Type=28            |  // FU indicator (1 byte)
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |S|E|R|  Original NALU Type     |  // FU header (1 byte)
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- FU indicator：1 字节，其中 F（1 bit）表示禁止位，NRI（2 bits）表示引用等级，Type（5 bits）表示 NALU 类型（对于 FU-A 类型，Type 的值为 28）。
- FU header：1 字节，其中 S（1 bit）表示开始位，E（1 bit）表示结束位，R（1 bit）为保留位（通常设置为 0），Original NALU Type（5 bits）表示原始 NALU 的类型（例如：I 帧、P 帧等）。

NAL Unit Payload：包含原始 H.264 NALU 的一部分数据。

OPTIONAL RTP padding：可选的 RTP 填充字节，用于将 RTP 包对齐到特定的字节边界。

通过将原始 NALU 分成多个 FU-A 片，可以将较大的 H.264 帧分片为多个较小的 RTP 包以进行传输。在接收端，这些 FU-A 片需要重新组合成完整的 NALU 以进行解码。

> 在WebRTC源码中，仅对FUA类型的H264包判断存不存在I帧（IDR），也就是默认STAP-A和SingleNALU装不下I帧。

3. **Single NALU**：对于较小的 H.264 帧（小于 MTU 大小），可以将整个 NALU 放入一个 RTP 包中进行传输。这种情况下，RTP 包中的负载就是单个 H.264 NALU。

```
+-------------------+----------------+-----------------------------------+
|   RTP Header      | NALU Header    |         NALU Payload              |
+-------------------+----------------+-----------------------------------+
|     12 bytes      |    1 byte      |   variable length (NALU data)     |
+-------------------+----------------+-----------------------------------+
```

1. **RTP Header**：RTP 包的头部，通常为 12 字节。包含了如时间戳、序列号、同步源 (SSRC) 等信息，用于正确处理和解码视频流。

2. **NALU Header**：H.264 NALU 的头部，占 1 字节。包含了 NALU 的类型，例如 SPS、PPS、I 帧（IDR 帧）等。可以通过获取头部字节的低 5 位（header & 0x1F）来确定 NALU 类型。

3. **NALU Payload**：实际的 H.264 NALU 数据，其长度是可变的。包含编码后的视频数据，用于解码和显示。

WebRTC 在处理 H.264 视频流时，通常会处理这三种类型的 RTP 包。这些包类型涵盖了 H.264 视频流在 RTP 中传输的常见情况。虽然 H.264 规范还定义了其他类型的 RTP 包（例如 FU-B、MTAP 等），但在 WebRTC 中并不常用。在大多数情况下，STAP-A、FU-A 和 Single NALU 足以处理 H.264 视频流。


